<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Asistencia - Producción Oral B2.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: auto;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        h1 {
            color: #1e40af;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 14px;
        }

        .qr-info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .session-info {
            font-size: 16px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .timestamp {
            font-size: 12px;
            color: #6b7280;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            transition: border-color 0.2s;
        }

        input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .success-message {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            margin-top: 20px;
            display: none;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            margin-top: 20px;
            display: none;
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #6b7280;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .back-link a:hover {
            color: #1e40af;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="images/Logo-CLM-V1.jpg" alt="Logo CLM" class="logo">
            <h1>Registro de Asistencia</h1>
            <p class="subtitle">Producción Oral B2.1</p>
        </div>

        <!-- QR Information -->
        <div class="qr-info" id="qrInfo">
            <div class="session-info" id="sessionInfo">Cargando información...</div>
            <div class="timestamp" id="timestampInfo"></div>
        </div>

        <!-- Registration Form -->
        <form id="attendanceForm">
            <div class="form-group">
                <label for="studentId">Código de Estudiante (4 dígitos)</label>
                <input type="text" id="studentId" required maxlength="4" placeholder="Ej: 1523" pattern="[0-9]{4}">
            </div>

            <div class="form-group">
                <label for="studentName">Nombre Completo</label>
                <input type="text" id="studentName" required placeholder="Ej: BAI, MIAORUI">
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="btnText">✓ Registrar Asistencia</span>
            </button>
        </form>

        <!-- Messages -->
        <div class="success-message" id="successMessage">
            ✅ Asistencia registrada correctamente
        </div>

        <div class="error-message" id="errorMessage">
            ❌ Error al registrar asistencia
        </div>

        <!-- Back to main page -->
        <div class="back-link">
            <a href="index.html">← Volver a la página principal</a>
        </div>
    </div>

    <script>
        // Database configuration (same as admin panel)
        const DB_NAME = 'AttendanceDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'attendance';

        // Authorized students
        const AUTHORIZED_STUDENTS = [
            { id: '1523', name: 'BAI, MIAORUI' },
            { id: '2847', name: 'CHAFFIN, NATHANIEL HAYEN' },
            { id: '3915', name: 'DIAZ, ANGELA CLARICE' },
            { id: '4602', name: 'KEMPF, RYAN ELIZABETH' },
            { id: '5789', name: 'LANTER, WESLEY MITCHELL' },
            { id: '6134', name: 'MANCIPE, GABRIEL FELIPE' },
            { id: '7256', name: 'MIRANDA, MARISOL ESPERANZA' },
            { id: '8901', name: 'MOREY, GABRIELLE KAI' },
            { id: '9467', name: 'PORTZLINE, EVAN GRACE' },
            { id: '1089', name: 'SALAZAR, NATALIE' }
        ];

        let db;
        let currentQRData = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('studentId', 'studentId', { unique: false });
                        store.createIndex('sessionId', 'sessionId', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
            });
        }

        // Get QR data from URL or localStorage
        function getQRData() {
            // Try to get from URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const qrDataParam = urlParams.get('qr');

            if (qrDataParam) {
                try {
                    return JSON.parse(decodeURIComponent(qrDataParam));
                } catch (e) {
                    console.error('Invalid QR data in URL');
                }
            }

            // Try to get from localStorage (for direct access)
            const stored = localStorage.getItem('currentQRData');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    console.error('Invalid QR data in localStorage');
                }
            }

            // Create default session if no QR data
            return {
                sessionId: generateSessionId(),
                timestamp: new Date().toISOString(),
                type: 'attendance'
            };
        }

        // Generate session ID
        function generateSessionId() {
            const now = new Date();
            const date = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const time = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
            return `${date}_${time}`;
        }

        // Update QR information display
        function updateQRInfo() {
            if (currentQRData) {
                const sessionInfo = document.getElementById('sessionInfo');
                const timestampInfo = document.getElementById('timestampInfo');

                const parts = currentQRData.sessionId.split('_');
                if (parts.length >= 2) {
                    const date = parts[0];
                    const time = parts[1];
                    const formattedDate = new Date(date).toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    sessionInfo.textContent = `Sesión: ${formattedDate} - ${time}`;
                    timestampInfo.textContent = `Generado: ${new Date(currentQRData.timestamp).toLocaleString('es-ES')}`;
                }
            }
        }

        // Validate student
        function validateStudent(studentId, studentName) {
            const student = AUTHORIZED_STUDENTS.find(s => s.id === studentId);
            if (!student) {
                return false;
            }

            // Check if name matches (case insensitive, allow partial matches)
            const normalizedName = studentName.toUpperCase().trim();
            const authorizedName = student.name.toUpperCase().trim();

            return normalizedName === authorizedName ||
                   normalizedName.includes(authorizedName.split(',')[0].trim()) ||
                   authorizedName.includes(normalizedName);
        }

        // Check if already registered for this session
        async function isAlreadyRegistered(studentId, sessionId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const index = store.index('studentId');
                const request = index.get(studentId);

                request.onsuccess = () => {
                    const records = request.result ? [request.result] : [];

                    // Need to check all records for this student
                    const allRequest = index.getAll(studentId);
                    allRequest.onsuccess = () => {
                        const studentRecords = allRequest.result || [];
                        const alreadyRegistered = studentRecords.some(record =>
                            record.sessionId === sessionId
                        );
                        resolve(alreadyRegistered);
                    };
                };

                request.onerror = () => reject(request.error);
            });
        }

        // Save attendance record
        async function saveAttendanceRecord(studentId, studentName, sessionId) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                const record = {
                    studentId: studentId,
                    studentName: studentName,
                    sessionId: sessionId,
                    timestamp: new Date().toISOString(),
                    ip: 'N/A', // Could get from server if needed
                    userAgent: navigator.userAgent
                };

                const request = store.add(record);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Show message
        function showMessage(type, message) {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');

            if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                errorEl.style.display = 'none';
            } else {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                successEl.style.display = 'none';
            }

            // Hide after 5 seconds
            setTimeout(() => {
                successEl.style.display = 'none';
                errorEl.style.display = 'none';
            }, 5000);
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');

            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();

            // Basic validation
            if (!studentId || !studentName) {
                showMessage('error', 'Por favor completa todos los campos');
                return;
            }

            if (studentId.length !== 4 || !/^\d{4}$/.test(studentId)) {
                showMessage('error', 'El código de estudiante debe tener 4 dígitos');
                return;
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span> Registrando...';

            try {
                // Validate student authorization
                if (!validateStudent(studentId, studentName)) {
                    showMessage('error', 'Estudiante no autorizado. Verifica tu código y nombre.');
                    return;
                }

                // Check if already registered
                const alreadyRegistered = await isAlreadyRegistered(studentId, currentQRData.sessionId);
                if (alreadyRegistered) {
                    showMessage('error', 'Ya has registrado tu asistencia para esta sesión');
                    return;
                }

                // Save attendance record
                await saveAttendanceRecord(studentId, studentName, currentQRData.sessionId);

                // Success
                showMessage('success', `✅ Asistencia registrada: ${studentName}`);

                // Clear form
                document.getElementById('attendanceForm').reset();

                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                console.error('Error registering attendance:', error);
                showMessage('error', 'Error al registrar asistencia. Intenta de nuevo.');
            } finally {
                // Restore button
                submitBtn.disabled = false;
                btnText.textContent = '✓ Registrar Asistencia';
            }
        }

        // Initialize page
        async function init() {
            try {
                await initDB();

                // Get QR data
                currentQRData = getQRData();

                // Also save to localStorage for admin panel to access
                localStorage.setItem('currentQRData', JSON.stringify(currentQRData));

                // Update QR info display
                updateQRInfo();

                // Setup form handler
                document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);

                // Focus on student ID input
                document.getElementById('studentId').focus();

            } catch (error) {
                console.error('Error initializing page:', error);
                showMessage('error', 'Error al inicializar la página. Recarga e intenta de nuevo.');
            }
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>