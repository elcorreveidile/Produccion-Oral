<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia - ProducciÃ³n Oral B2.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 500px;
            width: 100%;
            padding: 40px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        h1 {
            color: #1e40af;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .status {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .loading {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .info-form {
            text-align: left;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 5px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button {
            background: #1e40af;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        button:hover:not(:disabled) {
            background: #1d4ed8;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .details {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            color: #6b7280;
        }

        .timer {
            font-size: 18px;
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 15px;
        }

        .student-info {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #bae6fd;
        }

        .student-info p {
            margin: 5px 0;
            color: #1e40af;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="images/Logo-CLM-V1.jpg" alt="Logo CLM" class="logo">
        <h1>Asistencia - ProducciÃ³n Oral</h1>
        <p class="subtitle">Nivel B2.1 - Universidad de Granada</p>

        <div id="loading" class="status loading" style="display: none;">
            <p>Verificando enlace de asistencia...</p>
        </div>

        <div id="error" class="status error" style="display: none;">
            <p id="error-message">Enlace invÃ¡lido o ya utilizado</p>
        </div>

        <div id="form-container" style="display: none;">
            <div class="timer" id="timer"></div>

            <div class="student-info">
                <p><strong>Sesi&oacute;n:</strong> <span id="session-info">Cargando...</span></p>
                <p><strong>Fecha:</strong> <span id="date-info">Cargando...</span></p>
            </div>

            <form id="attendance-form" class="info-form">
                <div class="form-group">
                    <label for="student-name">Tu nombre (como prefieras) *</label>
                    <input type="text" id="student-name" required placeholder="Ej: Miaorui, Nathaniel, Angie...">
                </div>

                <div class="form-group">
                    <label for="student-id">Tu cÃ³digo de estudiante (4 dÃ­gitos) *</label>
                    <input type="text" id="student-id" required placeholder="Ej: 1523" maxlength="4" pattern="[0-9]{4}">
                </div>

                <button type="submit" id="submit-btn">
                    Registrar Asistencia
                </button>
            </form>

            <div class="details">
                <strong>Importante:</strong> Esta pÃ¡gina solo es vÃ¡lida para registrar tu asistencia hoy. Una vez confirmada, no podrÃ¡s volver a usar este mismo enlace.
                <br><br>
                <strong>Â¿No recuerdas tu cÃ³digo?</strong> Tu cÃ³digo de estudiante es un nÃºmero de 4 dÃ­gitos que te proporcionÃ³ el profesor al inicio del curso.
            </div>
        </div>

        <div id="success" class="status success" style="display: none;">
            <h3>âœ… Asistencia Registrada</h3>
            <p id="success-message">Tu asistencia ha sido registrada correctamente</p>
            <div id="student-registered" class="student-info" style="margin-top: 20px;">
                <!-- Student details will be shown here -->
            </div>
        </div>
    </div>

    <script>
        // URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const session = urlParams.get('session') || 'Sesion actual';

        // Configuration - Multiple Backup Systems
        const GIST_URL = 'https://gist.githubusercontent.com/elcorreveidile/'; // We'll use your GitHub gist
        const BACKUP_KEY = 'attendance_backup_' + new Date().getFullYear();
        const ADMIN_EMAIL = 'profesor@example.com'; // Your email for notifications

        // Lista de estudiantes autorizados con ID Ãºnico y variantes de nombre
        const AUTHORIZED_STUDENTS = [
            {
                id: '1523',
                fullName: 'BAI, MIAORUI',
                variants: ['Miaorui Bai', 'Miaorui', 'M. Bai', 'Bai']
            },
            {
                id: '2847',
                fullName: 'CHAFFIN, NATHANIEL HAYEN',
                variants: ['Nathaniel Chaffin', 'Nathaniel', 'N. Chaffin', 'Nat', 'Chaffin']
            },
            {
                id: '3915',
                fullName: 'DIAZ, ANGELA CLARICE',
                variants: ['Angela Diaz', 'Angela', 'A. Diaz', 'Diaz']
            },
            {
                id: '4602',
                fullName: 'KEMPF, RYAN ELIZABETH',
                variants: ['Ryan Kempf', 'Ryan', 'R. Kempf', 'Kempf']
            },
            {
                id: '5789',
                fullName: 'LANTER, WESLEY MITCHELL',
                variants: ['Wesley Lanter', 'Wesley', 'W. Lanter', 'Lanter']
            },
            {
                id: '6134',
                fullName: 'MANCIPE, GABRIEL FELIPE',
                variants: ['Gabriel Mancipe', 'Gabriel', 'G. Mancipe', 'Mancipe']
            },
            {
                id: '7256',
                fullName: 'MIRANDA, MARISOL ESPERANZA',
                variants: ['Marisol Miranda', 'Marisol', 'M. Miranda', 'Miranda']
            },
            {
                id: '8901',
                fullName: 'MOREY, GABRIELLE KAI',
                variants: ['Gabrielle Morey', 'Gabrielle', 'G. Morey', 'Morey', 'Kai']
            },
            {
                id: '9467',
                fullName: 'PORTZLINE, EVAN GRACE',
                variants: ['Evan Portzline', 'Evan', 'E. Portzline', 'Portzline']
            },
            {
                id: '1089',
                fullName: 'SALAZAR, NATALIE',
                variants: ['Natalie Salazar', 'Natalie', 'N. Salazar', 'Salazar']
            }
        ];

        // DOM elements
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const formContainer = document.getElementById('form-container');
        const success = document.getElementById('success');
        const form = document.getElementById('attendance-form');
        const submitBtn = document.getElementById('submit-btn');

        // Time tracking
        let timeRemaining = 300; // 5 minutes

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                showError('Enlace invÃ¡lido: falta el token de acceso');
                return;
            }

            initializeAttendance();
        });

        async function initializeAttendance() {
            loading.style.display = 'block';

            try {
                // In production, you'd verify token against your backend
                // For now, we'll simulate token validation
                await validateToken(token);

                // Load existing attendance data
                await loadAttendanceData();

                // Setup form
                setupForm();

                // Show form
                loading.style.display = 'none';
                formContainer.style.display = 'block';

                // Update session info
                document.getElementById('session-info').textContent = session;
                document.getElementById('date-info').textContent = new Date().toLocaleDateString('es-ES', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                // Start timer
                startTimer();

            } catch (err) {
                showError(err.message);
            }
        }

        async function validateToken(token) {
            // Simulate API call to validate token
            // In production, this would check against your database
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    // For demo: accept any token with length > 5
                    if (token.length > 5) {
                        resolve(true);
                    } else {
                        reject(new Error('Token invÃ¡lido'));
                    }
                }, 1000);
            });
        }

        async function loadAttendanceData() {
            // Load existing attendance data
            try {
                // In production, you'd fetch from your backend
                const response = await fetch(`${JSONBIN_URL}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_KEY
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.records || [];
                } else {
                    return [];
                }
            } catch (err) {
                console.warn('Could not load existing data, starting fresh');
                return [];
            }
        }

        function setupForm() {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitAttendance();
            });
        }

        function validateStudent(name, id) {
            const nameUpper = name.toUpperCase().trim();
            const idTrimmed = id.trim();

            // Strict validation by ID + name variant
            return AUTHORIZED_STUDENTS.find(student => {
                // First verify ID matches exactly
                if (student.id !== idTrimmed) {
                    return false;
                }

                // Then check if name matches any variant
                return student.variants.some(variant => {
                    const variantUpper = variant.toUpperCase();
                    return variantUpper === nameUpper;
                });
            });
        }

        async function submitAttendance() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentId = document.getElementById('student-id').value.trim();

            const formData = {
                token: token,
                session: session,
                studentName: studentName,
                studentId: studentId,
                timestamp: new Date().toISOString(),
                ipAddress: await getClientIP(),
                userAgent: navigator.userAgent
            };

            // Validate form
            if (!studentName || studentName.length < 2) {
                alert('Por favor, ingresa tu nombre.');
                return;
            }

            if (!studentId || studentId.length !== 4 || !/^\d{4}$/.test(studentId)) {
                alert('Por favor, ingresa tu cÃ³digo de estudiante de 4 dÃ­gitos.');
                return;
            }

            // Validate student is authorized by ID + name variant
            const authorizedStudent = validateStudent(studentName, studentId);
            if (!authorizedStudent) {
                alert('Acceso denegado. Verifica que:\n\n1. Tu cÃ³digo de estudiante sea correcto (4 dÃ­gitos)\n2. Tu nombre coincida con como estÃ¡s registrado\n\nSi no recuerdas tu cÃ³digo, contacta al profesor.');
                return;
            }

            // Check if already registered today (by ID, not name)
            const today = new Date().toDateString();
            const existingRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
            const alreadyRegistered = existingRecords.some(record => {
                const recordDate = new Date(record.timestamp).toDateString();
                const recordId = record.studentId;
                return recordDate === today && recordId === studentId;
            });

            if (alreadyRegistered) {
                alert('Ya has registrado tu asistencia hoy.');
                return;
            }

            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registrando...';

            try {
                // Save attendance record
                await saveAttendanceRecord(formData);

                // Notify admin panel
                notifyAdminPanel(formData);

                // Show success
                showSuccess(formData);

            } catch (err) {
                alert('Error al registrar asistencia: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar Asistencia';
            }
        }

        function saveAttendanceRecord(record) {
            console.log('ðŸ’¾ SIMPLE SAVE: Saving attendance record:', record);
            console.log('ðŸ’¾ localStorage available:', typeof Storage !== 'undefined');
            console.log('ðŸ’¾ Current localStorage contents:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(`  - ${key}: ${localStorage.getItem(key)?.substring(0, 100)}...`);
            }

            try {
                // SIMPLE: Just save to localStorage
                const existingRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
                console.log('ðŸ’¾ Existing records before:', existingRecords.length);
                console.log('ðŸ’¾ Existing records sample:', existingRecords.slice(0, 2));

                existingRecords.push(record);
                console.log('ðŸ’¾ Records after adding:', existingRecords.length);
                console.log('ðŸ’¾ New record added to array:', record);

                // Save to localStorage
                const dataToSave = JSON.stringify(existingRecords);
                console.log('ðŸ’¾ Data to save length:', dataToSave.length);
                localStorage.setItem('attendanceRecords', dataToSave);
                console.log('ðŸ’¾ localStorage.setItem called successfully');

                // Verify it was saved
                const verification = localStorage.getItem('attendanceRecords');
                console.log('ðŸ’¾ Verification - saved data length:', verification ? verification.length : 'null');
                console.log('ðŸ’¾ Verification - data matches:', verification === dataToSave);
                console.log('ðŸ’¾ Verification - parsed record count:', verification ? JSON.parse(verification).length : 0);

                if (verification === dataToSave) {
                    console.log('âœ… SUCCESS: Attendance record saved to localStorage');
                    console.log('âœ… Total records now in localStorage:', JSON.parse(localStorage.getItem('attendanceRecords')).length);

                    // Show success to user
                    showSaveConfirmation(['localStorage']);

                    // Force admin panel refresh
                    forceAdminPanelRefresh();

                    return true;
                } else {
                    console.error('âŒ FAILED: Data verification failed');
                    console.error('âŒ Expected length:', dataToSave.length);
                    console.error('âŒ Actual length:', verification?.length);
                    alert('âŒ Error al guardar el registro. Por favor, intenta de nuevo.');
                    return false;
                }
            } catch (err) {
                console.error('ðŸ’¥ CRITICAL ERROR in saveAttendanceRecord:', err);
                console.error('ðŸ’¥ Error stack:', err.stack);
                alert('ðŸ’¥ Error crÃ­tico al guardar. Por favor, toma una captura de pantalla.');
                return false;
            }
        }

        function showSaveConfirmation(methods) {
            console.log('âœ… Success confirmation for:', methods);

            const confirmationDiv = document.createElement('div');
            confirmationDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #16a34a;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                max-width: 300px;
                font-size: 14px;
            `;

            confirmationDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">âœ… REGISTRO GUARDADO</div>
                <div>MÃ©todo: ${methods.join(', ')}</div>
                <div style="font-size: 12px; margin-top: 8px;">Asistencia registrada exitosamente</div>
            `;

            document.body.appendChild(confirmationDiv);

            setTimeout(() => {
                document.body.removeChild(confirmationDiv);
            }, 5000);
        }

        function forceAdminPanelRefresh() {
            console.log('ðŸ”„ Forcing admin panel refresh...');
            console.log('ðŸ”„ Current localStorage data for attendanceRecords:', localStorage.getItem('attendanceRecords')?.substring(0, 200));

            try {
                // Simple refresh - reload the admin panel if open
                const adminUrl = 'https://elcorreveidile.github.io/Produccion-Oral/attendance-admin.html';
                console.log('ðŸ”„ Admin URL:', adminUrl);

                // Create storage event to force refresh
                const currentValue = localStorage.getItem('attendanceRecords');
                console.log('ðŸ”„ Storage event - current value length:', currentValue?.length);

                const refreshEvent = new StorageEvent('storage', {
                    key: 'attendanceRecords',
                    newValue: currentValue,
                    oldValue: null,
                    url: window.location.href,
                    storageArea: localStorage
                });

                console.log('ðŸ”„ Dispatching storage event...');
                window.dispatchEvent(refreshEvent);

                // Also try to trigger via localStorage change
                const tempKey = 'forceRefresh_' + Date.now();
                localStorage.setItem(tempKey, 'refresh');
                localStorage.removeItem(tempKey);

                console.log('ðŸ”„ Storage event dispatched successfully');
                console.log('ðŸ”„ All localStorage keys after refresh:', Object.keys(localStorage));

            } catch (error) {
                console.error('ðŸ”„ Error in forceAdminPanelRefresh:', error);
            }
        }

        function notifyAdminPanel(record) {
            // Save to localStorage with timestamp for immediate admin panel access
            localStorage.setItem('lastAttendanceRecord', JSON.stringify(record));

            // Create notification event for real-time updates
            const adminNotification = {
                type: 'new_attendance',
                record: record,
                timestamp: new Date().toISOString()
            };

            // Store notification for admin panel
            localStorage.setItem('adminNotification', JSON.stringify(adminNotification));

            // Dispatch custom event to notify admin panel (if it's open in another tab)
            window.dispatchEvent(new CustomEvent('attendanceUpdate', {
                detail: adminNotification
            }));

            // Also dispatch to storage event for cross-tab communication
            localStorage.setItem('attendanceUpdate', JSON.stringify(adminNotification));
        }

        function showSuccess(record) {
            formContainer.style.display = 'none';
            success.style.display = 'block';

            document.getElementById('success-message').textContent =
                `Â¡Gracias ${record.studentName}! Tu asistencia ha sido registrada para la ${record.session}.`;

            // Show student details
            const registeredInfo = document.getElementById('student-registered');
            registeredInfo.innerHTML = `
                <p><strong>Nombre:</strong> ${record.studentName}</p>
                <p><strong>Fecha y hora:</strong> ${new Date(record.timestamp).toLocaleString('es-ES')}</p>
            `;

            // Mark token as used (save to localStorage)
            const usedTokens = JSON.parse(localStorage.getItem('usedTokens') || '[]');
            usedTokens.push(token);
            localStorage.setItem('usedTokens', JSON.stringify(usedTokens));
        }

        function showError(message) {
            loading.style.display = 'none';
            error.style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function startTimer() {
            const timerElement = document.getElementById('timer');

            const interval = setInterval(() => {
                if (timeRemaining <= 0) {
                    clearInterval(interval);
                    showError('El enlace ha expirado. Por favor, solicita un nuevo cÃ³digo QR.');
                    return;
                }

                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerElement.textContent = `Tiempo restante: ${minutes}:${seconds.toString().padStart(2, '0')}`;

                timeRemaining--;
            }, 1000);
        }

        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (err) {
                return 'Unknown';
            }
        }
    </script>
</body>
</html>